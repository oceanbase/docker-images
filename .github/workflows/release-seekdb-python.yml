name: release seekdb-python

on:
  push:
    tags:
      - "seekdb-python-v*-*"

env:
  tagName: ${{ github.ref_name }}

jobs:
  build-wheels:
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
    runs-on: ${{ matrix.os }}
    outputs:
      seekdb_version: ${{ steps.extract_version.outputs.seekdb_version }}
      package_version: ${{ steps.extract_version.outputs.package_version }}
    steps:
      - name: Extract version from tag
        id: extract_version
        run: |
          # Extract versions from tag (e.g., 'seekdb-python-v1.0.0-1.0.0.post1')
          # Format: seekdb-python-{seekdb_version}-{pylibseekdb_version}
          TAG_WITHOUT_PREFIX=$(echo "${{ env.tagName }}" | sed 's/seekdb-python-//')

          # Split by last dash to separate seekdb version and pylibseekdb version
          # seekdb_version is everything before the last dash (e.g., 'v1.0.0')
          # package_version is everything after the last dash (e.g., '1.0.0.post1')
          SEEKDB_VERSION=$(echo "${TAG_WITHOUT_PREFIX}" | sed 's/-[^-]*$//')
          PACKAGE_VERSION=$(echo "${TAG_WITHOUT_PREFIX}" | sed 's/^.*-//')

          echo "seekdb_version=${SEEKDB_VERSION}" >> $GITHUB_OUTPUT
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted seekdb version: ${SEEKDB_VERSION}"
          echo "Extracted package version: ${PACKAGE_VERSION}"

      - name: Checkout repository
        uses: actions/checkout@v5

      - uses: actions/setup-python@v5

      - name: Build wheels on ${{ matrix.os }}
        uses: pypa/cibuildwheel@v3.3.0
        env:
          CIBW_BEFORE_BUILD: "pip install setuptools wheel build"
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"
          CIBW_SKIP: "*-musllinux_* *-win_* *-macosx_*"
          CIBW_ENVIRONMENT: "SEEKDB_GIT_TAG=${{ steps.extract_version.outputs.seekdb_version }} PACKAGE_VERSION=${{ steps.extract_version.outputs.package_version }} BUILD_TYPE=release REBUILD=1 SEEKDB_BUILD_LIBRARY=1"
          CIBW_BEFORE_BUILD_LINUX: |
            yum install -y -q git wget rpm* cpio make glibc-devel glibc-headers binutils m4 libtool libaio ccache
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28_x86_64
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28_aarch64
        with:
          package-dir: seekdb-python
          output-dir: wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels
          path: wheelhouse/*.whl
          retention-days: 30
