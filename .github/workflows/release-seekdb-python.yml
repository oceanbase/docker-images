name: release seekdb-python

on:
  push:
    tags:
      - "seekdb-python-*-*"

env:
  tagName: ${{ github.ref_name }}

jobs:
  build-wheels:
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-24.04-arm]
    runs-on: ${{ matrix.os }}
    outputs:
      seekdb_version: ${{ steps.extract_version.outputs.seekdb_version }}
      package_version: ${{ steps.extract_version.outputs.package_version }}
    steps:
      - name: Extract version from tag
        id: extract_version
        run: |
          # Extract versions from tag (e.g., 'seekdb-python-1.0.0-1.0.0.post1')
          # Format: seekdb-python-{seekdb_version}-{pylibseekdb_version}
          TAG_WITHOUT_PREFIX=$(echo "${{ env.tagName }}" | sed 's/seekdb-python-//')

          # Split by last dash to separate seekdb version and pylibseekdb version
          # seekdb_version is everything before the last dash (e.g., '1.0.0')
          # package_version is everything after the last dash (e.g., '1.0.0.post1')
          SEEKDB_VERSION=$(echo "${TAG_WITHOUT_PREFIX}" | sed 's/-[^-]*$//')
          PACKAGE_VERSION=$(echo "${TAG_WITHOUT_PREFIX}" | sed 's/^.*-//')

          echo "seekdb_version=${SEEKDB_VERSION}" >> $GITHUB_OUTPUT
          echo "package_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted seekdb version: ${SEEKDB_VERSION}"
          echo "Extracted package version: ${PACKAGE_VERSION}"

      - name: Free Disk Space
        uses: insightsengineering/disk-space-reclaimer@v1
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tools-cache: false

          # all of these default to true, but feel free to set to
          # "false" if necessary for your workflow
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Build wheels on ${{ matrix.os }}
        uses: pypa/cibuildwheel@v3.3.0
        env:
          CIBW_BEFORE_BUILD: "pip install setuptools wheel build"
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-* cp313-* cp314-*"
          CIBW_SKIP: "*-musllinux_* *-win_* *-macosx_*"
          CIBW_ENVIRONMENT: "SEEKDB_GIT_TAG=${{ steps.extract_version.outputs.seekdb_version }} PACKAGE_VERSION=${{ steps.extract_version.outputs.package_version }} BUILD_TYPE=release REBUILD=1 SEEKDB_BUILD_LIBRARY=1"
          CIBW_TEST_COMMAND: "python seekdb-python/seekdb_test.py"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
        with:
          package-dir: seekdb-python
          output-dir: wheelhouse

      - name: Upload wheels
        uses: actions/upload-artifact@v6
        with:
          name: wheels-${{ steps.extract_version.outputs.package_version }}-${{ runner.arch }}
          path: wheelhouse/*.whl
          retention-days: 30
          compression-level: 0

  publish:
    needs: build-wheels
    runs-on: ubuntu-latest
    permissions:
      id-token: write # OIDC needs this
      contents: read
    steps:
      - name: Download all wheels
        uses: actions/download-artifact@v6
        with:
          path: wheelhouse
          pattern: wheels-${{ needs.build-wheels.outputs.package_version }}-*
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1.13
        with:
          packages-dir: wheelhouse
          skip-existing: true
